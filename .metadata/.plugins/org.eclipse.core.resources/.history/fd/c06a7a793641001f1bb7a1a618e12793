/*
 * osKernel.c
 *
 *  Created on: Jul 12, 2024
 *      Author: E0162112
 */


#include "osKernel.h"


#define SYSTEM_CLK				8000000U
#define MILLIS_PRESCALER		1000U

//TCB_t tcbs[NUM_OF_THREADS];
TCB_t* tcbs;
TCB_t* current_thread;
uint8_t Tasks_number = 0;
uint32_t TCB_Stack[NUM_OF_THREADS][STACK_SIZE];

static void osKernelStack_Init(uint32_t thread);


osKernelReturn_t osKernel_ThreadCreate( TCB_t* task)
{
	__disable_irq();
	uint32_t task_stackSize = (task->stack_size) * sizeof(uint32_t);
	task->stack = (uint32_t *)malloc(task_stackSize);
	/*PSR register , set T-bit (bit21) to 1to operate in thumb mode*/
	task->stack[task_stackSize - 1] = 1U<<21;
	/*Assign PC register to point to task address*/
	task->stack[task_stackSize - 2] = task->callback_function;
	/*Initialize rest of registers by dummy value (optional for debugging)*/
	task->stack[task_stackSize -3] = 0xAAAAAAAA;  /*R14 (LR)*/
	task->stack[task_stackSize -4] = 0xAAAAAAAA;  /*R12*/
	task->stack[task_stackSize -5] = 0xAAAAAAAA;  /*R3*/
	task->stack[task_stackSize -6] = 0xAAAAAAAA;  /*R2*/
	task->stack[task_stackSize -7] = 0xAAAAAAAA;  /*R1*/
	task->stack[task_stackSize -8] = 0xAAAAAAAA;  /*R0*/
	/*Assign stack pointer to top of stack*/
	task->stackpt = task->stack[task_stackSize - 16];

	tcbs[Tasks_number]
	__enable_irq();
}


static void osKernelStack_Init(uint32_t thread)
{

	TCB_Stack[thread][STACK_SIZE -9] = 0xAAAAAAAA; /*R11*/
	TCB_Stack[thread][STACK_SIZE -10] = 0xAAAAAAAA; /*R10*/
	TCB_Stack[thread][STACK_SIZE -11] = 0xAAAAAAAA; /*R9*/
	TCB_Stack[thread][STACK_SIZE -12] = 0xAAAAAAAA; /*R8*/
	TCB_Stack[thread][STACK_SIZE -13] = 0xAAAAAAAA; /*R7*/
	TCB_Stack[thread][STACK_SIZE -14] = 0xAAAAAAAA; /*R6*/
	TCB_Stack[thread][STACK_SIZE -15] = 0xAAAAAAAA; /*R5*/
	TCB_Stack[thread][STACK_SIZE -16] = 0xAAAAAAAA; /*R4*/
}


osKernelReturn_t osKernel_init(uint32_t quanta)
{
	/* configure SysTick to 1ms*/
	timebase_ReloadTimeChange(quanta * (SYSTEM_CLK/MILLIS_PRESCALER));
	/*set SysTick to low priority*/
	NVIC_SetPriority(SysTick_IRQn,15);

}

